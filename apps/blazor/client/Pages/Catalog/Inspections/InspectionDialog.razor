<EditForm Model="@Model" OnValidSubmit="OnValidSubmit">
    <MudDialog>
        <TitleContent>
            <MudText Typo="Typo.h6">
                <MudIcon Icon="@Icons.Material.Filled.Checklist" Class="mr-2" />
                @(IsCreate ? "New Inspection - Step 3" : IsReadOnly ? "View Inspection" : "Edit Inspection")
            </MudText>
        </TitleContent>
        <DialogContent>
            <FshValidation @ref="_customValidation" />
            <DataAnnotationsValidator />
            <ValidationSummary />

            <MudGrid Spacing="2">
                <!-- PO Info Display -->
                @if (Model?.InspectionRequestId != null)
                {
                    var req = InspectionRequests.FirstOrDefault(r => r.Id == Model.InspectionRequestId);
                    if (req?.Purchase != null)
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-2" Icon="@Icons.Material.Filled.Receipt">
                                @{
                                    var poDate = req.Purchase.PurchaseDate?.ToString("MMM dd, yyyy");
                                    var poIdShort = req.Purchase.Id?.ToString()?.Substring(0, 8);
                                }
                                <strong>PO @poDate</strong> (@poIdShort) -
                                @req.Purchase.Supplier?.Name
                                @if (req.Purchase.Items?.Count > 0)
                                {
                                    <text> - @req.Purchase.Items.Count item(s)</text>
                                }
                            </MudAlert>
                        </MudItem>
                    }
                }

                <!-- Compact horizontal row: Request | Inspector | Date -->
                <MudItem xs="12">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                        <MudSelect T="Guid?" 
                                   Label="Inspection Request"
                                   Value="@Model?.InspectionRequestId"
                                   ValueChanged="OnRequestChanged"
                                   For="@(() => Model.InspectionRequestId)"
                                   Placeholder="Select inspection request"
                                   Clearable
                                   Variant="Variant.Outlined"
                                   Dense="true"
                                   Margin="Margin.Dense"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.RequestPage"
                                   Class="input-field request-field">
                            @foreach (var r in InspectionRequests.Where(r => r.Status == InspectionRequestStatus.Assigned || r.Status == InspectionRequestStatus.InProgress))
                            {
                                <MudSelectItem T="Guid?" Value="@r.Id">
                                    @r.DateCreated.ToString("MMM dd, yyyy") - @(r.Purchase?.Supplier?.Name ?? "Unknown Supplier")
                                </MudSelectItem>
                            }
                        </MudSelect>

                        <MudSelect T="Guid?" 
                                   Label="Inspector" 
                                   @bind-Value="Model.InspectorId"
                                   Placeholder="Select inspector"
                                   Clearable
                                   Variant="Variant.Outlined"
                                   Dense="true"
                                   Margin="Margin.Dense"
                                   Adornment="Adornment.Start"
                                   AdornmentIcon="@Icons.Material.Filled.Badge"
                                   HelperText="@(_inspectorAutoFilled ? "Auto-filled from request" : "")"
                                   Class="input-field">
                            @foreach (var e in Employees)
                            {
                                <MudSelectItem T="Guid?" Value="@e.Id">@e.Name @(!string.IsNullOrEmpty(e.Designation) ? $"- {e.Designation}" : "")</MudSelectItem>
                            }
                        </MudSelect>

                        <MudDatePicker Label="Inspection Date"
                                       Date="@_inspectionDate"
                                       DateChanged="@(d => OnDateChanged(d))"
                                       Editable
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Adornment="Adornment.Start"
                                       AdornmentIcon="@Icons.Material.Filled.Event"
                                       Class="input-field date-field" />
                    </MudStack>
                </MudItem>

                <!-- Remarks Section -->
                <MudItem xs="12">
                    <MudTextField T="string" 
                                  Label="Remarks" 
                                  @bind-Value="Model!.Remarks"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Lines="3"
                                  Placeholder="Add any additional notes or observations..." />
                </MudItem>

                <!-- Inspection Items Section -->
                <MudItem xs="12">
                    <MudPaper Elevation="2" Class="pa-3">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-3">
                            <MudText Typo="Typo.h6">
                                <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Small" /> 
                                Inspection Checklist
                            </MudText>
                            <MudSpacer />
                            @if (_itemsEditor?.Inputs != null && _itemsEditor.Inputs.Count > 0)
                            {
                                <MudChip T="string" Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small">
                                    @_itemsEditor.Inputs.Sum(i => i.QtyPassed) Passed
                                </MudChip>
                                <MudChip T="string" Icon="@Icons.Material.Filled.Cancel" Color="Color.Error" Size="Size.Small">
                                    @_itemsEditor.Inputs.Sum(i => i.QtyFailed) Failed
                                </MudChip>
                                <MudChip T="string" Icon="@Icons.Material.Filled.Info" Color="Color.Info" Size="Size.Small">
                                    @_itemsEditor.Inputs.Sum(i => i.QtyInspected) / @_itemsEditor.Inputs.Sum(i => i.OrderedQty) Inspected
                                </MudChip>
                            }
                        </MudStack>
                        <InspectionItemsEditor @ref="_itemsEditor" 
                                             PurchaseItems="@GetPurchaseItemsForSelectedRequest()" 
                                             Products="_products" 
                                             ReadOnly="@IsReadOnly" />
                    </MudPaper>
                </MudItem>

                <!-- Evidence Upload Section --  >
                <MudItem xs="12">
                    <MudPaper Elevation="1" Class="pa-3">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">
                            <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" />
                            Upload Evidence (Optional)
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mb-2">
                            Attach photos or documents for damaged or rejected items
                        </MudText>
                        <MudFileUpload T="IReadOnlyList<IBrowserFile>" 
                                       OnFilesChanged="OnFilesChanged"
                                       MaximumFileCount="5"
                                       Accept="image/*,.pdf"
                                       Disabled="@IsReadOnly">
                            <ActivatorContent>
                                <MudButton Variant="Variant.Outlined"
                                           Color="Color.Primary"
                                           StartIcon="@Icons.Material.Filled.CloudUpload"
                                           Disabled="@IsReadOnly">
                                    Upload Files
                                </MudButton>
                            </ActivatorContent>
                        </MudFileUpload>
                        @if (_uploadedFiles?.Count > 0)
                        {
                            <MudList Dense="true" Class="mt-2">
                                @foreach (var file in _uploadedFiles)
                                {
                                    <MudListItem>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                            <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" />
                                            <MudText Typo="Typo.body2">@file.Name (@FormatFileSize(file.Size))</MudText>
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                           Size="Size.Small" 
                                                           Color="Color.Error"
                                                           OnClick="@(() => RemoveFile(file))"
                                                           Disabled="@IsReadOnly" />
                                        </MudStack>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                    </MudPaper>
                </MudItem-->
            </MudGrid>
        </DialogContent>

        <DialogActions>
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Class="flex-grow-1">
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Secondary" 
                           OnClick="Cancel"
                           Disabled="@_isSaving"
                           StartIcon="@Icons.Material.Filled.Cancel">
                    Cancel
                </MudButton>
                <MudSpacer />
                @if (!IsReadOnly && !IsCreate)
                {
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success" 
                               OnClick="ApproveInspection"
                               Disabled="@_isSaving"
                               StartIcon="@Icons.Material.Filled.CheckCircle">
                        Accept & Add to Inventory
                    </MudButton>
                }
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           ButtonType="ButtonType.Submit"
                           Disabled="@(_isSaving || IsReadOnly)"
                           StartIcon="@Icons.Material.Filled.Save">
                    @if (_isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        <text> Saving...</text>
                    }
                    else
                    {
                        <text>@(IsCreate ? "Create Inspection" : "Update Inspection")</text>
                    }
                </MudButton>
            </MudStack>
        </DialogActions>
    </MudDialog>
</EditForm>


