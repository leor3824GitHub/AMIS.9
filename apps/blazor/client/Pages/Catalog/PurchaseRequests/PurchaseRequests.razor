@page "/catalog/purchaserequests"
@using AMIS.Blazor.Client.Components
@using AMIS.Blazor.Infrastructure.Api
@using MudBlazor

<PageHeader Title="Purchase Requests" Header="Purchase Request Management"
    SubHeader="Create, submit, approve or reject purchase requests" />

<MudPaper Class="pa-4">
    <MudStack Row="true" Spacing="2" Class="mb-4">
        @if (_canSearch)
        {
            <MudTextField T="string" ValueChanged="@(s => OnSearch(s))"
                Placeholder="Search by requester, purpose, or status..." Adornment="Adornment.Start"
                AdornmentIcon="@Icons.Material.Filled.Search" Variant="Variant.Outlined" Disabled="@_loading" />
        }
        <MudSpacer />
        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Disabled="@_loading" OnClick="@OnRefresh"
            StartIcon="@Icons.Material.Filled.Refresh">Refresh</MudButton>

        @if (_canCreate)
        {
            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@_loading" OnClick="OnCreate"
                StartIcon="@Icons.Material.Filled.Add">New Request</MudButton>
        }

    </MudStack>

    <MudDataGrid ServerData="ServerReload" T="PurchaseRequestResponse" MultiSelection="true"
        @bind-SelectedItems="_selectedItems" @bind-SelectedItem="_currentDto" Hover="true" Dense="true" Bordered="true"
        Striped="true" Loading="@_loading" @ref="_table">

        <Columns>
            <SelectColumn T="PurchaseRequestResponse" />
            <PropertyColumn Property="x => x.RequestDate" Title="Request Date" />
            <PropertyColumn Property="x => x.RequestedBy" Title="Requested By" />
            <PropertyColumn Property="x => x.Purpose" Title="Purpose" />
            <TemplateColumn Title="Status" Sortable="false">
                <CellTemplate>
                    <MudChip Size="Size.Small" Color="@GetStatusColor(context.Item.Status)" Variant="Variant.Filled">
                        @context.Item.Status
                    </MudChip>
                </CellTemplate>
            </TemplateColumn>
            <TemplateColumn Title="Actions" Sortable="false">
                <CellTemplate>
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense Size="Size.Small">
                        <MudMenuItem OnClick="@(() => OnView(context.Item))">
                            <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" />
                                <MudText>View</MudText>
                            </MudStack>
                        </MudMenuItem>
                        @if (context.Item.Status == PurchaseRequestStatus.Draft)
                        {
                            <MudMenuItem Disabled="@(!_canUpdate)" OnClick="@(() => OnSubmit(context.Item))">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Send" Size="Size.Small" Color="Color.Info" />
                                    <MudText>Submit</MudText>
                                </MudStack>
                            </MudMenuItem>
                            <MudMenuItem Disabled="@(!_canUpdate)" OnClick="@(() => OnCancel(context.Item))">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Default" />
                                    <MudText>Cancel</MudText>
                                </MudStack>
                            </MudMenuItem>
                        }
                        @if (context.Item.Status == PurchaseRequestStatus.Submitted)
                        {
                            <MudMenuItem Disabled="@(!_canUpdate)" OnClick="@(() => OnApprove(context.Item))">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small"
                                        Color="Color.Success" />
                                    <MudText>Approve</MudText>
                                </MudStack>
                            </MudMenuItem>
                            <MudMenuItem Disabled="@(!_canUpdate)" OnClick="@(() => OnReject(context.Item))">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Block" Size="Size.Small" Color="Color.Error" />
                                    <MudText>Reject</MudText>
                                </MudStack>
                            </MudMenuItem>
                            <MudMenuItem Disabled="@(!_canUpdate)" OnClick="@(() => OnCancel(context.Item))">
                                <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                                    <MudIcon Icon="@Icons.Material.Filled.Cancel" Size="Size.Small" Color="Color.Default" />
                                    <MudText>Cancel</MudText>
                                </MudStack>
                            </MudMenuItem>
                        }
                    </MudMenu>
                </CellTemplate>
            </TemplateColumn>
        </Columns>

        <PagerContent>
            <MudDataGridPager />
        </PagerContent>
    </MudDataGrid>
</MudPaper>