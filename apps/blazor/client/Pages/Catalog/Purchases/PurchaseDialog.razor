<EditForm Model="@Model" OnValidSubmit="OnValidSubmit">

    <MudDialog Style="height: 850px; overflow-y: auto;">
        <DialogContent>
            <DataAnnotationsValidator />
            <ValidationSummary />

            <!-- Workflow Progress Indicator -->
            @if (!IsCreate.GetValueOrDefault())
            {
                <PurchaseWorkflowStepper Status="@Model.Status" ReferenceNumber="@Model.ReferenceNumber" />
            }

            <!-- Purchase Information Section -->
            <MudPaper Class="pa-4 mt-3" Elevation="2" Square="true">
                <MudText Typo="Typo.h6" Class="mb-3">Purchase Order Details</MudText>
                <MudGrid>
                    <!-- Header Row: PO Number, Date, Status -->
                    <MudItem xs="12" sm="4" md="3">
                        <MudTextField @bind-Value="Model.ReferenceNumber" Variant="Variant.Outlined" Label="PO Number"
                            ReadOnly="true" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Receipt"
                            HelperText="Auto-generated" />
                    </MudItem>
                    <MudItem xs="12" sm="4" md="3">
                        <MudDatePicker @bind-Date="Model.PurchaseDate" Variant="Variant.Outlined" Label="Date"
                            For="@(() => Model.PurchaseDate)" />
                    </MudItem>
                    <MudItem xs="12" sm="4" md="3">
                        <MudSelect T="PurchaseStatus" Variant="Variant.Outlined" Label="Status"
                            @bind-Value="Model.Status" ReadOnly="true">
                            @foreach (var status in PurchaseStatusList)
                            {
                                <MudSelectItem T="PurchaseStatus" Value="status">@GetDisplayName(status)</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="12" md="3">
                        <MudTextField @bind-Value="Model.TotalAmount" Variant="Variant.Outlined" Label="Total Amount"
                            For="@(() => Model.TotalAmount)" Format="N2" ReadOnly="true" />
                    </MudItem>

                    <!-- Supplier, Delivery Address, and Remarks in horizontal layout -->
                    <MudItem xs="12" sm="4" md="4">
                        <MudSelect T="Guid ?" Variant="Variant.Outlined" Label="Supplier" @bind-Value="Model.SupplierId"
                            Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Business">
                            @foreach (var suppliers in _suppliers)
                            {
                                <MudSelectItem T="Guid ?" Value="suppliers.Id">@suppliers.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="4" md="4">
                        <MudTextField @bind-Value="Model.DeliveryAddress" Variant="Variant.Outlined"
                            Label="Delivery Address" Adornment="Adornment.Start"
                            AdornmentIcon="@Icons.Material.Filled.LocationOn" Placeholder="Enter delivery location"
                            Lines="1" />
                    </MudItem>

                    <MudItem xs="12" sm="4" md="4">
                        <MudTextField @bind-Value="Model.Remarks" Variant="Variant.Outlined" Label="Remarks"
                            Placeholder="Add any notes or comments..." Lines="1" />
                    </MudItem>

                    <!-- Supplier Info Block - Compact Layout -->
                    <MudItem xs="12">
                        @{
                            var selectedSupplier = _suppliers.FirstOrDefault(s => s.Id == Model.SupplierId);
                        }
                        @if (selectedSupplier != null)
                        {
                            <MudPaper Class="pa-2" Elevation="0" Square="true">
                                <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Start">
                                    <MudStack Spacing="0" Style="min-width: 120px;">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Address</MudText>
                                        <MudText Typo="Typo.body2">@(!string.IsNullOrWhiteSpace(selectedSupplier.Address) ?
                                                                                    selectedSupplier.Address : "-")</MudText>
                                    </MudStack>
                                    <MudStack Spacing="0" Style="min-width: 100px;">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Contact</MudText>
                                        <MudText Typo="Typo.body2">@(!string.IsNullOrWhiteSpace(selectedSupplier.ContactNo)
                                                                                    ? selectedSupplier.ContactNo : "-")</MudText>
                                    </MudStack>
                                    <MudStack Spacing="0" Style="min-width: 120px;">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Email</MudText>
                                        <MudText Typo="Typo.body2">@(!string.IsNullOrWhiteSpace(selectedSupplier.Emailadd) ?
                                                                                    selectedSupplier.Emailadd : "-")</MudText>
                                    </MudStack>
                                    <MudStack Spacing="0" Style="min-width: 80px;">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">TIN</MudText>
                                        <MudText Typo="Typo.body2">@(!string.IsNullOrWhiteSpace(selectedSupplier.Tin) ?
                                                                                    selectedSupplier.Tin : "-")</MudText>
                                    </MudStack>
                                    <MudStack Spacing="0" Style="min-width: 100px;">
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">Tax Class</MudText>
                                        <MudText Typo="Typo.body2">
                                            @(!string.IsNullOrWhiteSpace(selectedSupplier.TaxClassification) ?
                                                                                    selectedSupplier.TaxClassification : "-")</MudText>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }
                    </MudItem>
                </MudGrid>
            </MudPaper>
            <br />

            <!-- Workflow Action Buttons -->
            @if (!IsCreate.GetValueOrDefault())
            {
                <MudPaper Class="pa-3 mb-3" Elevation="1" Square="true">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Workflow Actions:</MudText>

                        @if (Model.Status == PurchaseStatus.Draft || Model.Status == PurchaseStatus.Pending)
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Send"
                                OnClick="SubmitPurchase">
                                Submit for Approval
                            </MudButton>
                        }

                        @if (Model.Status == PurchaseStatus.Submitted)
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Success"
                                StartIcon="@Icons.Material.Filled.CheckCircle" OnClick="IssuePurchase">
                                Issue PO
                            </MudButton>
                        }

                        @if (Model.Status == PurchaseStatus.Delivered)
                        {
                            <MudButton Variant="Variant.Filled" Color="Color.Info" StartIcon="@Icons.Material.Filled.Lock"
                                OnClick="ClosePurchase">
                                Close PO
                            </MudButton>
                        }

                        @if (Model.Status != PurchaseStatus.Closed && Model.Status != PurchaseStatus.Cancelled)
                        {
                            <MudButton Variant="Variant.Outlined" Color="Color.Error" StartIcon="@Icons.Material.Filled.Cancel"
                                OnClick="CancelPurchase">
                                Cancel PO
                            </MudButton>
                        }

                        <MudSpacer />
                        <MudChip T="string" Icon="@GetWorkflowStepIcon()" Color="@GetWorkflowStepColor()" Size="Size.Small">
                            @GetWorkflowStepText()
                        </MudChip>
                    </MudStack>
                </MudPaper>
            }

            <!-- ✅ Include PurchaseItemList inside the same DialogContent -->
            <PurchaseItemList Items="@Model.Items" Products="_products" Suppliers="_suppliers" Status="@Model.Status"
                PurchaseId="@Model.Id" OnTotalAmountChanged="UpdateTotalAmount" IsCreate="@IsCreate" />

        </DialogContent>

        <DialogActions>
            <MudButton OnClick="Cancel" Variant="Variant.Filled" Color="Color.Default">Cancel</MudButton>
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary"
                StartIcon="@Icons.Material.Filled.Save">
                @(IsCreate.GetValueOrDefault() ? "Create Purchase" : "Save Changes")
            </MudButton>
        </DialogActions>

    </MudDialog>
</EditForm>