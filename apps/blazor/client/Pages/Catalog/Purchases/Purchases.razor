@page "/catalog/purchases"

@* <style>
    .mud-table-container {
        overflow: auto;
    }
</style> *@
<PageHeader Title="Purchases" Header="Purchases" SubHeader="Manage your Purchases." />
@* <div class="d-flex flex-column">
    <div style="line-height: 1; margin-bottom: 4px;">
        <MudText Typo="Typo.h6" Class="m-0">List of Purchases</MudText>
    </div> *@
<MudDataGrid ServerData="ServerReload"
             MultiSelection="true"
             @bind-SelectedItems="_selectedItems"
             @bind-SelectedItem="_currentDto"
             ColumnResizeMode="ResizeMode.Column"
             Hover="true"
             Loading="@_loading" 
             @ref="_table"
             Outlined>
        <ToolBarContent>
            <div class="d-flex align-center justify-between w-100 gap-2 flex-wrap">

                <!-- 📦 Left: Buttons -->
                <div class="d-flex align-center flex-nowrap gap-1">
                    <MudHidden Breakpoint="Breakpoint.SmAndDown">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   DropShadow="false"
                                   Disabled="@_loading"
                                   OnClick="@(() => OnRefresh())"
                                   StartIcon="@Icons.Material.Filled.Refresh"
                                   IconColor="Color.Surface">Refresh</MudButton>

                        @if (_canCreate)
                        {
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       DropShadow="false"
                                       StartIcon="@Icons.Material.Filled.Add"
                                       Disabled="@_loading"
                                       OnClick="OnCreate"
                                       IconColor="Color.Surface">
                                New
                            </MudButton>

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Tertiary"
                                       DropShadow="false"
                                       StartIcon="@Icons.Material.Filled.ContentCopy"
                                       Disabled="@(_selectedItems.Count != 1)"
                                       OnClick="OnClone"
                                       IconColor="Color.Surface">
                                Clone
                            </MudButton>
                        }

                        @if (_canDelete)
                        {
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Error"
                                       DropShadow="false"
                                       StartIcon="@Icons.Material.Filled.Delete"
                                       Disabled="@(!(_selectedItems.Count > 0))"
                                       OnClick="OnDeleteChecked"
                                       IconColor="Color.Surface">
                                Delete
                            </MudButton>
                        }
                    </MudHidden>

                    <!-- ☰ Actions for Small Screens -->
                    <MudHidden Breakpoint="Breakpoint.MdAndUp">
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Dense="true">
                            <MudMenuItem OnClick="@(() => OnRefresh())" Disabled="@_loading">Refresh</MudMenuItem>

                            @if (_canCreate)
                            {
                                <MudMenuItem OnClick="OnCreate" Disabled="@_loading">New</MudMenuItem>
                                <MudMenuItem OnClick="OnClone" Disabled="@(_selectedItems.Count != 1)">Clone</MudMenuItem>
                            }

                            @if (_canDelete)
                            {
                                <MudMenuItem OnClick="OnDeleteChecked" Disabled="@(_selectedItems.Count == 0)">Delete</MudMenuItem>
                            }
                        </MudMenu>
                    </MudHidden>
                </div>

                <div class="d-flex align-center gap-2 flex-grow-1 justify-end flex-wrap">
                    @if (_canSearch)
                    {
                        <MudTextField T="string"
                                      ValueChanged="@(s => OnSearch(s))"
                                      Placeholder="Search"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      IconSize="Size.Medium"
                                      Style="min-width: 220px;"
                                      Class="mt-0"
                                      Dense="true" />
                    }

                    <MudSwitch Checked="_supplierDeliveredOnly"
                               CheckedChanged="OnSupplierDeliveredChanged"
                               Disabled="@_loading"
                               Color="Color.Success"
                               Class="mt-0"
                               Label="Supplier delivered only" />
                </div>
            </div>
        </ToolBarContent>

    <Columns>
        <SelectColumn T="PurchaseResponse" />
        
        <TemplateColumn Title="PO Number" Sortable="false">
            <CellTemplate>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Small" Color="Color.Primary" />
                    <MudText Typo="Typo.body2" Style="font-family: monospace;">
                        @(context.Item.Id.HasValue ? context.Item.Id.Value.ToString().Substring(0, 8) : "-")
                    </MudText>
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
        
        <TemplateColumn Title="Supplier" Sortable="false">
            <CellTemplate>
                @{
                    var supplierName = context.Item.Supplier?.Name ?? "-";
                }

                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="flex-wrap">
                    <MudText Typo="Typo.body2">@supplierName</MudText>

                    @if (IsSupplierDelivered(context.Item))
                    {
                        <MudChip Color="Color.Success"
                                 Variant="Variant.Outlined"
                                 Size="Size.Small"
                                 StartIcon="@Icons.Material.Filled.LocalShipping">
                            Supplier Delivered
                        </MudChip>
                    }
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x => x.PurchaseDate" Title="Purchase Date" />
        <PropertyColumn Property="x => x.TotalAmount" Title="Total Amount" />
        <TemplateColumn Title="Status" Sortable="false">
            <CellTemplate>
                <MudStack Row="false" Spacing="1">
                    <MudChip Color="@GetStatusColor(context.Item.Status)"
                             Variant="Variant.Filled"
                             Size="Size.Small"
                             Icon="@GetStatusIcon(context.Item.Status)"
                             Class="text-uppercase">
                        @context.Item.Status
                    </MudChip>
                    @if (context.Item.Status == PurchaseStatus.Draft || context.Item.Status == PurchaseStatus.Pending)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Step 1: PO Creation</MudText>
                    }
                    else if (context.Item.Status == PurchaseStatus.Submitted || context.Item.Status == PurchaseStatus.PartiallyDelivered)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Step 2: Goods Receipt</MudText>
                    }
                    else if (context.Item.Status == PurchaseStatus.Delivered)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Step 3: Inspection</MudText>
                    }
                </MudStack>
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Action">
            <CellTemplate>
                <MudMenu Icon="@Icons.Material.Filled.MoreVert" 
                         Variant="Variant.Filled" 
                         Size="Size.Small"
                         Dense="true"
                         IconColor="Color.Info" 
                         AnchorOrigin="Origin.CenterLeft">

                    <MudMenuItem OnClick="@(() => OnEdit(context.Item))">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Info" />
                            <MudText>Edit</MudText>
                        </MudStack>
                    </MudMenuItem>

                    @if (CanRecordDelivery(context.Item))
                    {
                        <MudMenuItem OnClick="@(() => OnRecordDelivery(context.Item))">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Size="Size.Small" Color="Color.Success" />
                                <MudText>Record Delivery</MudText>
                            </MudStack>
                        </MudMenuItem>
                    }

                    <MudDivider />
                    
                    <MudMenuItem OnClick="@(() => OnDelete(context.Item))">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" />
                            <MudText>Delete</MudText>
                        </MudStack>
                    </MudMenuItem>
                </MudMenu>
            </CellTemplate>
        </TemplateColumn>
    </Columns>
    <PagerContent>
        <MudDataGridPager />
    </PagerContent>
</MudDataGrid>

